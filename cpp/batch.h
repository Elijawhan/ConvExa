#include <convexa.h>
#include <cxkernels.h>

#include <helper.h>

#define TYPE_USED float

void b_main() {

    printf("\n******************************************\n");
    printf("Beginning Convolution Test:\n");
    std::vector<int16_t> data;
    // HELP::wav_hdr hdr = HELP::read_wav("./cpp/audio/subroutines.wav", &data);
    HELP::wav_hdr hdr = HELP::read_wav("./cpp/audio/badadeedur.wav", &data);
    printf("Audio Sampling Rate: %dHz\n", hdr.SamplesPerSec);
    std::vector<TYPE_USED> fdata = HELP::vec_cast<int16_t, TYPE_USED>(data);
    std::vector<TYPE_USED> fdata_smol = std::vector<TYPE_USED>({ 1, 2, 3, 4, 5});
    // Filter Design software used: http://t-filter.engineerjs.com
    std::vector<TYPE_USED> myKernel_smol = {6, 7, 8};
    std::vector<TYPE_USED> myKernel = {0.005184042182695352, 0.00048479825762196997, 0.0005061197474262169, 0.0005270715548515555, 0.0005475890126449697,
                                   0.0005676036724039025, 0.0005870631509281676, 0.0006059009136524695, 0.000624040883389753, 0.0006413492301257154, 0.000657734482648827,
                                   0.0006731593746308583, 0.0006875614962714815, 0.0007008126483952237, 0.0007127726885099106, 0.0007234364085612756, 0.0007327589621457485,
                                   0.0007405426422992027, 0.0007466304990428558, 0.0007512768238413562, 0.000753930696143233, 0.0007549258420079964, 0.000753924009221302,
                                   0.0007509307042260055, 0.0007459207658376115, 0.0007388010020544589, 0.0007294559288278784, 0.000717869283728511, 0.0007039925401124001,
                                   0.0006877253575670166, 0.0006689755343370651, 0.000647709135768383, 0.000623910833868026, 0.000597499372521527, 0.0005684320964058756,
                                   0.0005366919152698136, 0.0005023016886999454, 0.0004648917070243855, 0.0004253549998193388, 0.00038195201457015353, 0.0003364569398397805,
                                   0.00028813430041773274, 0.00023664806790050133, 0.00018227077388818048, 0.00012521667091660972, 0.00006538502277090388, 0.0000026288455973533553,
                                   -0.00006306517538503894, -0.0001315418321182407, -0.00020264880270889454, -0.0002763719353548365, -0.0003527628082860776, -0.0004317850131349371,
                                   -0.0005132025652277849, -0.0005968947501794434, -0.000683065543042798, -0.0007716950083721049, -0.0008617628443519105, -0.0009543599844234213,
                                   -0.001048514256063498, -0.0011445457371358622, -0.0012422258842239788, -0.0013414371609871015, -0.0014420712066375743, -0.0015440086527434738,
                                   -0.0016470447745335073, -0.0017510136478121213, -0.001855783931803268, -0.001961191576475446, -0.002067016433219676, -0.002173037436966849,
                                   -0.0022790985604752446, -0.0023849619379270105, -0.002490339454013404, -0.0025949597033425587, -0.002698754583690222, -0.00280110173690879,
                                   -0.002902294718994509, -0.0030016178397250124, -0.0030991077528286304, -0.003194670919447353, -0.0032880286476013555, -0.0033789727195037106,
                                   -0.0034674173623630753, -0.0035531492662213364, -0.003635810038360161, -0.0037149584890544996, -0.003790130618010192, -0.003860822163944312,
                                   -0.003926506088822127, -0.003986875238347082, -0.004042104064518838, -0.004093189875249663, -0.004141958234051139, -0.00418942441052495,
                                   -0.0042143357754578165, -0.004247161602591259, -0.004269314532651421, -0.004285127641722224, -0.004294125887771026, -0.004296077826026462,
                                   -0.004290760063492023, -0.004277940066208328, -0.004257350452701134, -0.004228800576042927, -0.004192131136563893, -0.004147138628921476,
                                   -0.00409359188777707, -0.004031311055564854, -0.003960215001081793, -0.0038801180203404334, -0.0037907794355133517, -0.0036920933905993636,
                                   -0.0035841281108453743, -0.003466359247305504, -0.0033391231999429817, -0.0032019549789930163, -0.003054941507347741, -0.002898015123088944,
                                   -0.00273105274654797, -0.0025539950247214236, -0.002366888323040963, -0.0021697032421575785, -0.00196239063030552, -0.0017449548571541423,
                                   -0.0015174562635774673, -0.0012799417420441329, -0.001032419073047098, -0.0007749757691368792, -0.0005077200456708839, -0.0002307581212773416,
                                   0.000056011031259007945, 0.0003515789927586205, 0.0006581861386049346, 0.0009721726813765679, 0.0012959130576923582, 0.0016290582499333564,
                                   0.001970694613973104, 0.0023204847370860197, 0.002678503506709069, 0.003044730858502618, 0.00341890768314483, 0.0038005931660220677,
                                   0.004189388678889107, 0.004585024929692667, 0.00498725636174229, 0.005395757251267224, 0.0058101283404614805, 0.006230144601145877,
                                   0.006655636113076586, 0.007086061088621877, 0.007520630835604879, 0.007959799771654915, 0.008402340756061092, 0.008848393468107726,
                                   0.00929734620866006, 0.009748838868157916, 0.010202481554167983, 0.010657829552772955, 0.011114363398528808, 0.011571632374514116,
                                   0.012029188007642607, 0.012486535618272364, 0.012943170070020956, 0.013398642844087151, 0.013852557149617672, 0.01430443149889202,
                                   0.014753796454895145, 0.015200224149743128, 0.015643361911631345, 0.016082413118306667, 0.01651744210529123, 0.01694723522599648,
                                   0.017371782265153214, 0.0177905108403108, 0.018202760508986643, 0.01860815021639787, 0.019006424111228406, 0.019397184644238823,
                                   0.019779990973887263, 0.02015441225179944, 0.020519998337105716, 0.020876189005414894, 0.021222353089949554, 0.02155803668505264,
                                   0.02188312858089687, 0.022197869969212195, 0.022502231948289094, 0.022794709070024375, 0.02307203245771131, 0.023341446070503768,
                                   0.02359573270354146, 0.023837730001671407, 0.024066465076250675, 0.02428174450365746, 0.02448332634873539, 0.024670957875749223,
                                   0.02484438374864059, 0.025003442108684458, 0.025147968550965582, 0.025277759877774943, 0.02539263438383761, 0.02549248404440431,
                                   0.02557723862994907, 0.025646719912158073, 0.02570080072879326, 0.025739487465442253, 0.025762807973907263, 0.025770441452485308,
                                   0.025762807973907263, 0.025739487465442253, 0.02570080072879326, 0.025646719912158073, 0.02557723862994907, 0.02549248404440431,
                                   0.02539263438383761, 0.025277759877774943, 0.025147968550965582, 0.025003442108684458, 0.02484438374864059, 0.024670957875749223,
                                   0.02448332634873539, 0.02428174450365746, 0.024066465076250675, 0.023837730001671407, 0.02359573270354146, 0.023341446070503768,
                                   0.02307203245771131, 0.022794709070024375, 0.022502231948289094, 0.022197869969212195, 0.02188312858089687, 0.02155803668505264,
                                   0.021222353089949554, 0.020876189005414894, 0.020519998337105716, 0.02015441225179944, 0.019779990973887263, 0.019397184644238823,
                                   0.019006424111228406, 0.01860815021639787, 0.018202760508986643, 0.0177905108403108, 0.017371782265153214, 0.01694723522599648,
                                   0.01651744210529123, 0.016082413118306667, 0.015643361911631345, 0.015200224149743128, 0.014753796454895145, 0.01430443149889202,
                                   0.013852557149617672, 0.013398642844087151, 0.012943170070020956, 0.012486535618272364, 0.012029188007642607, 0.011571632374514116,
                                   0.011114363398528808, 0.010657829552772955, 0.010202481554167983, 0.009748838868157916, 0.00929734620866006, 0.008848393468107726,
                                   0.008402340756061092, 0.007959799771654915, 0.007520630835604879, 0.007086061088621877, 0.006655636113076586, 0.006230144601145877,
                                   0.0058101283404614805, 0.005395757251267224, 0.00498725636174229, 0.004585024929692667, 0.004189388678889107, 0.0038005931660220677,
                                   0.00341890768314483, 0.003044730858502618, 0.002678503506709069, 0.0023204847370860197, 0.001970694613973104, 0.0016290582499333564,
                                   0.0012959130576923582, 0.0009721726813765679, 0.0006581861386049346, 0.0003515789927586205, 0.000056011031259007945, -0.0002307581212773416,
                                   -0.0005077200456708839, -0.0007749757691368792, -0.001032419073047098, -0.0012799417420441329, -0.0015174562635774673, -0.0017449548571541423,
                                   -0.00196239063030552, -0.0021697032421575785, -0.002366888323040963, -0.0025539950247214236, -0.00273105274654797, -0.002898015123088944,
                                   -0.003054941507347741, -0.0032019549789930163, -0.0033391231999429817, -0.003466359247305504, -0.0035841281108453743, -0.0036920933905993636,
                                   -0.0037907794355133517, -0.0038801180203404334, -0.003960215001081793, -0.004031311055564854, -0.00409359188777707, -0.004147138628921476,
                                   -0.004192131136563893, -0.004228800576042927, -0.004257350452701134, -0.004277940066208328, -0.004290760063492023, -0.004296077826026462,
                                   -0.004294125887771026, -0.004285127641722224, -0.004269314532651421, -0.004247161602591259, -0.0042143357754578165, -0.00418942441052495,
                                   -0.004141958234051139, -0.004093189875249663, -0.004042104064518838, -0.003986875238347082, -0.003926506088822127, -0.003860822163944312,
                                   -0.003790130618010192, -0.0037149584890544996, -0.003635810038360161, -0.0035531492662213364, -0.0034674173623630753, -0.0033789727195037106,
                                   -0.0032880286476013555, -0.003194670919447353, -0.0030991077528286304, -0.0030016178397250124, -0.002902294718994509, -0.00280110173690879,
                                   -0.002698754583690222, -0.0025949597033425587, -0.002490339454013404, -0.0023849619379270105, -0.0022790985604752446, -0.002173037436966849,
                                   -0.002067016433219676, -0.001961191576475446, -0.001855783931803268, -0.0017510136478121213, -0.0016470447745335073, -0.0015440086527434738,
                                   -0.0014420712066375743, -0.0013414371609871015, -0.0012422258842239788, -0.0011445457371358622, -0.001048514256063498, -0.0009543599844234213,
                                   -0.0008617628443519105, -0.0007716950083721049, -0.000683065543042798, -0.0005968947501794434, -0.0005132025652277849, -0.0004317850131349371,
                                   -0.0003527628082860776, -0.0002763719353548365, -0.00020264880270889454, -0.0001315418321182407, -0.00006306517538503894, 0.0000026288455973533553,
                                   0.00006538502277090388, 0.00012521667091660972, 0.00018227077388818048, 0.00023664806790050133, 0.00028813430041773274, 0.0003364569398397805,
                                   0.00038195201457015353, 0.0004253549998193388, 0.0004648917070243855, 0.0005023016886999454, 0.0005366919152698136, 0.0005684320964058756,
                                   0.000597499372521527, 0.000623910833868026, 0.000647709135768383, 0.0006689755343370651, 0.0006877253575670166, 0.0007039925401124001,
                                   0.000717869283728511, 0.0007294559288278784, 0.0007388010020544589, 0.0007459207658376115, 0.0007509307042260055, 0.000753924009221302,
                                   0.0007549258420079964, 0.000753930696143233, 0.0007512768238413562, 0.0007466304990428558, 0.0007405426422992027, 0.0007327589621457485,
                                   0.0007234364085612756, 0.0007127726885099106, 0.0007008126483952237, 0.0006875614962714815, 0.0006731593746308583, 0.000657734482648827,
                                   0.0006413492301257154, 0.000624040883389753, 0.0006059009136524695, 0.0005870631509281676, 0.0005676036724039025, 0.0005475890126449697,
                                   0.0005270715548515555, 0.0005061197474262169, 0.00048479825762196997, 0.005184042182695352};

    printf("Kernel size: %d taps\n", myKernel.size());
    std::vector<TYPE_USED> myResult_h;
    std::vector<TYPE_USED> myResult_h_smol;
    float base_convolve_h_timing = CXTiming::host_convolve(fdata, myKernel, myResult_h);
    CXTiming::host_convolve(fdata_smol, myKernel_smol, myResult_h_smol);
    std::vector<TYPE_USED> myResult_d;

    const std::vector<std::vector<TYPE_USED>> input_sigs = {fdata, fdata_smol};
    const std::vector<std::vector<TYPE_USED>> input_kern = {myKernel, myKernel_smol};

    std::vector<std::vector<TYPE_USED>> batch_result = ConvExa::batch_convolution(input_sigs, input_kern);
    
    long double re = HELP::relative_error(batch_result[0], myResult_h);
    printf("Relative Error batch [0]: %.8Lf ", re);
    if (re < HELP::MAX_RELATIVE_ERROR_FLOAT)
        printf("PASS\n");
    else
        printf("FAIL\n");

    re = HELP::relative_error(batch_result[1], myResult_h_smol);
    printf("Relative Error batch [1]: %.8Lf ", re);
    if (re < HELP::MAX_RELATIVE_ERROR_FLOAT)
        printf("PASS\n");
    else
        printf("FAIL\n");




}